rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS (Mantidas do seu código)
    // ============================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserCompanyId() {
      // Nota: Essa função pode falhar se o doc do usuário não existir.
      // Por isso removemos a dependência dela na regra de CRIAÇÃO de usuário abaixo.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function belongsToCompany(companyId) {
      return isAuthenticated() && 
             getUserCompanyId() == companyId;
    }
    
    function isOwnerOrAdmin(companyId) {
      return isAuthenticated() && 
             belongsToCompany(companyId) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'owner');
    }
    
    function canReadCompany(companyId) {
      return isAuthenticated() && belongsToCompany(companyId);
    }

    // ============================================
    // 1. COMPANIES & DATA ISOLATION (Multi-Tenant)
    // ============================================
    match /companies/{companyId} {
      allow read: if canReadCompany(companyId);
      
      // Allow creation if:
      // 1. User is owner/admin of the company (normal case), OR
      // 2. User doesn't have a companyId yet (first-time setup) AND sets ownerId to their uid
      allow create: if isAuthenticated() && 
                       (isOwnerOrAdmin(companyId) ||
                        (!exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
                         !('companyId' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data) ||
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == '' ||
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == null) &&
                        request.resource.data.ownerId == request.auth.uid);
      
      allow update: if isOwnerOrAdmin(companyId) && 
                        request.resource.data.keys().hasAll(['updatedAt']);
      allow delete: if false; 
      
      match /{document=**} {
        allow read: if canReadCompany(companyId);
        allow write: if isOwnerOrAdmin(companyId);
      }
    }

    // ============================================
    // 2. QUOTES (Isolated by companyId)
    // ============================================
    match /quotes/{quoteId} {
      allow read: if isAuthenticated() && 
                      resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                        request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId();
    }

    // ============================================
    // 3. WORK ORDERS (Isolated by companyId)
    // ============================================
    match /workOrders/{workOrderId} {
      allow read: if isAuthenticated() && 
                      resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                        request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId();
    }

    // ============================================
    // 4. CLIENTS (Isolated by companyId)
    // ============================================
    match /clients/{clientId} {
      allow read: if isAuthenticated() && 
                      resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                        request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId();
    }

    // ============================================
    // 5. USERS (CORREÇÃO DE SEGURANÇA / DEADLOCK)
    // ============================================
    match /users/{userId} {
      // CORREÇÃO CRÍTICA: Simplificamos a regra para permitir o "Auto-Cura".
      // Se o ID do usuário logado bater com o ID do documento, ele tem permissão total
      // para criar ou editar sua própria ficha. Isso resolve o erro "User document does not exist".
      allow read, write: if request.auth.uid == userId;
      
      // Mantemos apenas a proteção contra deletar a conta acidentalmente.
      allow delete: if false;
    }

    // ============================================
    // 6. REFERRALS (Anti-Fraud Lock)
    // ============================================
    match /referrals/{referralId} {
      allow create: if isAuthenticated() &&
                        request.resource.data.referrerId == request.auth.uid;
      allow read: if isAuthenticated() && 
                      resource.data.referrerId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    // ============================================
    // 7. PHONE REGISTRY (Anti-Fraud & Verificação)
    // ============================================
    match /phone_registry/{phoneNumber} {
      allow read: if isAuthenticated();
      
      // CORREÇÃO: Simplificado para permitir que a tela de Ativação crie o registro
      // sem barreiras complexas de validação de payload.
      allow create: if isAuthenticated();
      
      allow update: if false; // Imutável
      allow delete: if false; // Imutável
    }

    // ============================================
    // 8. TAX ID REGISTRY (Anti-Fraud)
    // ============================================
    match /tax_id_registry/{taxId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }

    // ============================================
    // 9. DEFAULT DENY (Security by default)
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}