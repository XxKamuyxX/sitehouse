rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function hasCompanyId() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserDoc().data.companyId != null &&
             getUserDoc().data.companyId is string &&
             getUserDoc().data.companyId != '';
    }
    
    function getUserCompanyId() {
      return hasCompanyId() ? getUserDoc().data.companyId : null;
    }
    
    // Helper function for master check (must be at top level)
    function isMaster() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserDoc().data.role == 'master';
    }
    
    // Users - own document access OR master can read/write all
    match /users/{userId} {
      // Master can read/write ANY user. Regular users can only read/write their own.
      allow read: if isAuthenticated() && (request.auth.uid == userId || isMaster());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isMaster());
    }
    
    // Clients - CRITICAL: Queries with companyId filter are allowed via allow read
    match /clients/{clientId} {
      allow read: if isAuthenticated() && 
                     hasCompanyId() &&
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Companies - own company document OR master can read/write all
    match /companies/{companyId} {
      // Master can read/write any company. Regular users can only access their own.
      allow read: if isAuthenticated() && 
                     ((hasCompanyId() && resource.id == getUserCompanyId()) || isMaster());
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.id == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       ((hasCompanyId() && 
                         resource.id == getUserCompanyId() &&
                         request.resource.id == getUserCompanyId()) || isMaster());
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.id == getUserCompanyId();
    }
    
    // Work Orders - Public read and approval allowed
    match /workOrders/{workOrderId} {
      // Public read access (for sharing links)
      allow read: if true;
      
      // Only authenticated users with companyId can create
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      
      // Update rules:
      // 1. Authenticated users can update their own company's work orders
      // 2. Unauthenticated users can ONLY update approval/rejection fields
      allow update: if (isAuthenticated() && hasCompanyId() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId()) ||
                      // Public approval: allow unauthenticated updates ONLY for approval fields
                      (!isAuthenticated() &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['approved', 'rejected', 'approvedAt', 'rejectedAt', 'updatedAt']));
      
      // Only authenticated users with companyId can delete
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Expenses
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && 
                     hasCompanyId() && 
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Quotes
    match /quotes/{quoteId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if (isAuthenticated() && hasCompanyId() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId()) ||
                      (request.resource.data.diff(resource.data).unchangedKeys()
                        .hasAll(['clientId', 'clientName', 'items', 'subtotal', 'discount', 'total', 'warranty', 'observations', 'diagnosis', 'createdAt', 'companyId'])
                        && request.resource.data.status in ['approved', 'rejected']
                        && request.resource.data.updatedAt is timestamp);
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Receipts
    match /receipts/{receiptId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Settings
    match /settings/{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    // Templates
    match /templates/{templateId} {
      // All authenticated users can read templates
      allow read: if isAuthenticated();
      
      // Only master can create/update/delete templates
      allow create, update, delete: if isMaster();
    }
    
        // Services
        match /services/{serviceId} {
          allow read: if isAuthenticated() && 
                         hasCompanyId() && 
                         resource.data.companyId == getUserCompanyId();
          allow create: if isAuthenticated() && 
                           hasCompanyId() && 
                           request.resource.data.companyId == getUserCompanyId();
          allow update: if isAuthenticated() && 
                           hasCompanyId() && 
                           resource.data.companyId == getUserCompanyId() &&
                           request.resource.data.companyId == getUserCompanyId();
          allow delete: if isAuthenticated() && 
                           hasCompanyId() && 
                           resource.data.companyId == getUserCompanyId();
        }
        
        // Referral Ledger - Commission tracking
        match /referral_ledger/{ledgerId} {
          // Users can read their own referral ledger entries (where they are the referrer)
          allow read: if isAuthenticated() && 
                         hasCompanyId() && 
                         resource.data.referrerId == getUserCompanyId();
          
          // Only server/admin can create ledger entries (via processPaymentCommission)
          allow create: if isAuthenticated() && 
                           hasCompanyId() && 
                           request.resource.data.referrerId == getUserCompanyId();
          
          // Users can update their own ledger entries for status changes (pending -> released -> paid)
          allow update: if isAuthenticated() && 
                           hasCompanyId() && 
                           resource.data.referrerId == getUserCompanyId() &&
                           request.resource.data.referrerId == getUserCompanyId() &&
                           // Only allow updating status, releasedAt, and paidAt fields
                           request.resource.data.diff(resource.data).affectedKeys()
                             .hasOnly(['status', 'releasedAt', 'paidAt', 'updatedAt']);
          
          // No delete allowed for ledger entries (audit trail)
          allow delete: if false;
        }
        
        // Payout Requests - Withdrawal requests from affiliates
        match /payout_requests/{requestId} {
          // Users can read their own payout requests
          allow read: if isAuthenticated() && 
                         ((hasCompanyId() && resource.data.companyId == getUserCompanyId()) || isMaster());
          
          // Users can create their own payout requests
          allow create: if isAuthenticated() && 
                           hasCompanyId() && 
                           request.resource.data.companyId == getUserCompanyId() &&
                           request.resource.data.status == 'pending' &&
                           request.resource.data.amount is number &&
                           request.resource.data.pixKey is string;
          
          // Master can update any payout request (to approve/pay/reject)
          // Users cannot update their own requests
          allow update: if isMaster();
          
          // No delete allowed (audit trail)
          allow delete: if false;
        }
      }
    }
