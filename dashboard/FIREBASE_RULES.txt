rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function getUserCompanyId() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    match /clients/{clientId} {
      allow read: if isAuthenticated() && 
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    match /workOrders/{workOrderId} {
      // Allow public read for client viewing
      allow read: if true;
      
      // Only authenticated users from the same company can create
      allow create: if isAuthenticated() && 
                       request.resource.data.companyId == getUserCompanyId();
      
      // Allow updates in two scenarios:
      // 1. Authenticated users from the same company (full access)
      // 2. Public users (unauthenticated) can only update approval/feedback fields
      allow update: if (isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId()) ||
                      // Public update: only allow changes to approval/feedback fields
                      (!isAuthenticated() &&
                       request.resource.data.diff(resource.data).unchangedKeys()
                         .hasAll(['quoteId', 'clientName', 'clientId', 'scheduledDate', 'scheduledTime', 'technician', 'status', 'checklist', 'notes', 'photos', 'technicalInspection', 'createdAt', 'companyId', 'items', 'total']) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['approved', 'rejected', 'approvedAt', 'rejectedAt', 'updatedAt', 'feedbackSubmitted', 'feedbackRating', 'feedbackDate', 'feedbackComment']));
      
      // Only authenticated users from the same company can delete
      allow delete: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && 
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    match /quotes/{quoteId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if (isAuthenticated() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId()) ||
                      (request.resource.data.diff(resource.data).unchangedKeys()
                        .hasAll(['clientId', 'clientName', 'items', 'subtotal', 'discount', 'total', 'warranty', 'observations', 'diagnosis', 'createdAt', 'companyId'])
                        && request.resource.data.status in ['approved', 'rejected']
                        && request.resource.data.updatedAt is timestamp);
      allow delete: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    match /receipts/{receiptId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    match /settings/{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    match /companies/{companyId} {
      allow read: if isAuthenticated() && 
                     resource.id == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       request.resource.id == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       resource.id == getUserCompanyId() &&
                       request.resource.id == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       resource.id == getUserCompanyId();
    }
    
    function isMaster() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'master';
    }
    
    match /templates/{templateId} {
      // Allow READ for any authenticated user (all glaziers can see master templates)
      allow read: if isAuthenticated();
      // Only master admins can write (create, update, delete)
      allow create, update, delete: if isMaster();
    }
    
    match /services/{serviceId} {
      allow read: if isAuthenticated() && 
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       resource.data.companyId == getUserCompanyId();
    }
  }
}
