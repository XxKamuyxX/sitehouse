rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function hasCompanyId() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserDoc().data.companyId != null &&
             getUserDoc().data.companyId is string &&
             getUserDoc().data.companyId != '';
    }
    
    function getUserCompanyId() {
      return hasCompanyId() ? getUserDoc().data.companyId : null;
    }
    
    // Users - own document access OR master can read all
    match /users/{userId} {
      function isMaster() {
        return isAuthenticated() && 
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               getUserDoc().data.role == 'master';
      }
      allow read: if (isAuthenticated() && request.auth.uid == userId) || isMaster();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Clients - CRITICAL: Queries with companyId filter are allowed via allow read
    match /clients/{clientId} {
      allow read: if isAuthenticated() && 
                     hasCompanyId() &&
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Companies - own company document OR master can read all
    match /companies/{companyId} {
      function isMaster() {
        return isAuthenticated() && 
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               getUserDoc().data.role == 'master';
      }
      allow read: if (isAuthenticated() && 
                       hasCompanyId() && 
                       resource.id == getUserCompanyId()) || isMaster();
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.id == getUserCompanyId();
      allow update: if (isAuthenticated() && 
                       hasCompanyId() && 
                       resource.id == getUserCompanyId() &&
                       request.resource.id == getUserCompanyId()) || isMaster();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.id == getUserCompanyId();
    }
    
    // Work Orders
    match /workOrders/{workOrderId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if (isAuthenticated() && hasCompanyId() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId()) ||
                      (!isAuthenticated() &&
                       request.resource.data.diff(resource.data).unchangedKeys()
                         .hasAll(['quoteId', 'clientName', 'clientId', 'scheduledDate', 'scheduledTime', 'technician', 'status', 'checklist', 'notes', 'photos', 'technicalInspection', 'createdAt', 'companyId', 'items', 'total']) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['approved', 'rejected', 'approvedAt', 'rejectedAt', 'updatedAt', 'feedbackSubmitted', 'feedbackRating', 'feedbackDate', 'feedbackComment']));
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Expenses
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && 
                     hasCompanyId() && 
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Quotes
    match /quotes/{quoteId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if (isAuthenticated() && hasCompanyId() && 
                        resource.data.companyId == getUserCompanyId() &&
                        request.resource.data.companyId == getUserCompanyId()) ||
                      (request.resource.data.diff(resource.data).unchangedKeys()
                        .hasAll(['clientId', 'clientName', 'items', 'subtotal', 'discount', 'total', 'warranty', 'observations', 'diagnosis', 'createdAt', 'companyId'])
                        && request.resource.data.status in ['approved', 'rejected']
                        && request.resource.data.updatedAt is timestamp);
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Receipts
    match /receipts/{receiptId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
    
    // Settings
    match /settings/{document=**} {
      allow read, write: if isAuthenticated();
    }
    
    // Templates
    match /templates/{templateId} {
      allow read: if isAuthenticated();
      
      function isMaster() {
        return isAuthenticated() && 
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               getUserDoc().data.role == 'master';
      }
      
      allow create, update, delete: if isMaster();
    }
    
    // Services
    match /services/{serviceId} {
      allow read: if isAuthenticated() && 
                     hasCompanyId() && 
                     resource.data.companyId == getUserCompanyId();
      allow create: if isAuthenticated() && 
                       hasCompanyId() && 
                       request.resource.data.companyId == getUserCompanyId();
      allow update: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      allow delete: if isAuthenticated() && 
                       hasCompanyId() && 
                       resource.data.companyId == getUserCompanyId();
    }
  }
}
